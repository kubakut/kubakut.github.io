L.Control.Locate=L.Control.extend({options:{position:"topleft",drawCircle:!0,follow:!1,stopFollowingOnDrag:!1,circleStyle:{color:"#136AEC",fillColor:"#136AEC",fillOpacity:.15,weight:2,opacity:.5},markerStyle:{color:"#136AEC",fillColor:"#2A93EE",fillOpacity:.7,weight:2,opacity:.9,radius:5},followCircleStyle:{},followMarkerStyle:{},circlePadding:[0,0],metric:!0,onLocationError:function(o){alert(o.message)},onLocationOutsideMapBounds:function(o){o.stopLocate(),alert(context.options.strings.outsideMapBoundsMsg)},setView:!0,strings:{title:"Show me where I am",popup:"You are within {distance} {unit} from this point",outsideMapBoundsMsg:"You seem located outside the boundaries of the map"},locateOptions:{maxZoom:1/0,watch:!0}},onAdd:function(o){var t=L.DomUtil.create("div","leaflet-control-locate leaflet-bar leaflet-control"),e=this;this._layer=new L.LayerGroup,this._layer.addTo(o),this._event=void 0,this._locateOptions=this.options.locateOptions,L.extend(this._locateOptions,this.options.locateOptions),L.extend(this._locateOptions,{setView:!1});var n={};L.extend(n,this.options.markerStyle,this.options.followMarkerStyle),this.options.followMarkerStyle=n,n={},L.extend(n,this.options.circleStyle,this.options.followCircleStyle),this.options.followCircleStyle=n;var i=L.DomUtil.create("a","leaflet-bar-part leaflet-bar-part-single",t);i.href="#",i.title=this.options.strings.title,L.DomEvent.on(i,"click",L.DomEvent.stopPropagation).on(i,"click",L.DomEvent.preventDefault).on(i,"click",function(){e._active&&(void 0===e._event||o.getBounds().contains(e._event.latlng)||!e.options.setView||c())?d():l()}).on(i,"dblclick",L.DomEvent.stopPropagation);var l=function(){e.options.setView&&(e._locateOnNextLocationFound=!0),e._active||o.locate(e._locateOptions),e._active=!0,e.options.follow&&r(),e._event?f():(L.DomUtil.addClass(e._container,"requesting"),L.DomUtil.removeClass(e._container,"active"),L.DomUtil.removeClass(e._container,"following"))},a=function(o){e._event&&e._event.latlng.lat===o.latlng.lat&&e._event.latlng.lng===o.latlng.lng&&e._event.accuracy===o.accuracy||e._active&&(e._event=o,e.options.follow&&e._following&&(e._locateOnNextLocationFound=!0),f())},r=function(){o.fire("startfollowing",e),e._following=!0,e.options.stopFollowingOnDrag&&o.on("dragstart",s)},s=function(){o.fire("stopfollowing",e),e._following=!1,e.options.stopFollowingOnDrag&&o.off("dragstart",s),f()},c=function(){return void 0===e._event?!1:o.options.maxBounds&&!o.options.maxBounds.contains(e._event.latlng)},f=function(){void 0===e._event.accuracy&&(e._event.accuracy=0);var t=e._event.accuracy;e._locateOnNextLocationFound&&(c()?e.options.onLocationOutsideMapBounds(e):o.fitBounds(e._event.bounds,{padding:e.options.circlePadding,maxZoom:e._locateOptions.maxZoom}),e._locateOnNextLocationFound=!1);var n,i;if(e.options.drawCircle)if(n=e._following?e.options.followCircleStyle:e.options.circleStyle,e._circle){e._circle.setLatLng(e._event.latlng).setRadius(t);for(i in n)e._circle.options[i]=n[i]}else e._circle=L.circle(e._event.latlng,t,n).addTo(e._layer);var l,a;e.options.metric?(l=t.toFixed(0),a="meters"):(l=(3.2808399*t).toFixed(0),a="feet");var r;r=e._following?e.options.followMarkerStyle:e.options.markerStyle;var s=e.options.strings.popup;if(e._circleMarker){e._circleMarker.setLatLng(e._event.latlng).bindPopup(L.Util.template(s,{distance:l,unit:a}))._popup.setLatLng(e._event.latlng);for(i in r)e._circleMarker.options[i]=r[i]}else e._circleMarker=L.circleMarker(e._event.latlng,r).bindPopup(L.Util.template(s,{distance:l,unit:a})).addTo(e._layer);e._container&&(e._following?(L.DomUtil.removeClass(e._container,"requesting"),L.DomUtil.addClass(e._container,"active"),L.DomUtil.addClass(e._container,"following")):(L.DomUtil.removeClass(e._container,"requesting"),L.DomUtil.addClass(e._container,"active"),L.DomUtil.removeClass(e._container,"following")))},p=function(){e._active=!1,e._locateOnNextLocationFound=e.options.setView,e._following=!1};p();var d=function(){o.stopLocate(),o.off("dragstart",s),L.DomUtil.removeClass(e._container,"requesting"),L.DomUtil.removeClass(e._container,"active"),L.DomUtil.removeClass(e._container,"following"),p(),e._layer.clearLayers(),e._circleMarker=void 0,e._circle=void 0},u=function(o){3==o.code&&this._locateOptions.watch||(d(),e.options.onLocationError(o))};return o.on("locationfound",a,e),o.on("locationerror",u,e),this.locate=l,this.stopLocate=d,this.stopFollowing=s,t}}),L.Map.addInitHook(function(){this.options.locateControl&&(this.locateControl=L.control.locate(),this.addControl(this.locateControl))}),L.control.locate=function(o){return new L.Control.Locate(o)};